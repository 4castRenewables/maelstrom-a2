name:    ap2-all
outpath: ap2_run
comment: MAELSTROM AP2 benchmark jube script for training

parameterset:
  - name: appParameter
    parameter:
      - name: iteration
        tag: benchs
        type: int
        _: 1,2,3
      - name: iteration
        tag: "!benchs"
        type: int
        _: 1

      - name: path_apptainer_image
        tag: "jnvidia"
        type: string
        _: /p/project/deepacf/maelstrom/ehlert1/apptainer_images/ap2deberta.sif

      - name: base_path_training_set
        tag: "!e4"
        type: str
        _: /p/project/deepacf/maelstrom/ehlert1/a2/cluster/benchmarks3.7/ap2_run/000005/000000_submit/work/output_model/dataset_split_thresh0M2/
      - name: filename_dataset_train
        type: str
        _: ${base_path_training_set}/tweets_2017_01_era5_normed_filtered_train.nc
      - name: filename_dataset_validate
        type: str
        _: ${base_path_training_set}/tweets_2017_01_era5_normed_filtered_validate.nc
      - name: filename_dataset_test
        type: str
        _: ${base_path_training_set}/tweets_2017_01_era5_normed_filtered_test.nc
      - name: key_input
        type: string
        _: "text"
      - name: key_output
        type: string
        _: "raining"
      - name: key_raining
        type: string
        _: "raining"
      - name: key_text
        type: string
        _: "text_normalized"
      - name: filename_tweets
        tag: split+!e4
        _: /p/project/deepacf/maelstrom/ehlert1/data/tweets/tweets_2017_01_era5_normed_filtered.nc

      - name: model_path
        tag: "jwb|jwc"
        _: /p/project/deepacf/maelstrom/ehlert1/deberta-v3-small/
      - name: model_path
        tag: e4
        _: /data/maelstrom/kehlert/models/deberta-v3-small
      - name: model_name
        _: deberta_small
      - name: epochs
        type: int
        _: 1
      - name: batch_size
        type: int
        _: 32
      - name: learning_rate
        type: float
        _: 0.00003
      - name: weight_decay
        type: float
        _: 0

      - name: outdir
        type: string
        _: "$jube_wp_abspath/output_model"
      - name: run_name
        _: "${jube_benchmark_name}_${jube_benchmark_id}"

      - name: slurm_output
        type: string
        _: "$jube_wp_abspath/slurm-out.%j"
      - name: slurm_error
        type: string
        _: "$jube_wp_abspath/slurm-err.%j"
      - name: run_folder
        type: string
        _: $run_name
  - name: globalParameter
    parameter:
      - name: modules
        tag: e4
        separator: |
        _:
          module load slurm
      - name: modules
        tag: "!e4"
        separator: |
        _:
          ""
      - name: systemname
        tag: jwc
        _: jwc
      - name: systemname
        tag: jwb
        _: jwb
  - name: executeset
    init_with: platform.xml
  - name: systemParameter
    init_with: platform.xml
    parameter:
      - name: preprocess
        mode: text
        separator: |
        _: |
          ${power_measure_setup}
          source ~/.bashrc
          ${modules}
          export ${visible_devices}
      - name: power_measure_setup
        tag: e4
        mode: text
        separator: |
        _: |
          label=$$(/opt/share/scripts/powerdiscovery/getlabel.sh);
          echo "POWERMEASUREMENT: Label = $$label";
          /opt/share/scripts/powerdiscovery/getpower_bg.sh 1000 &;
      - name: power_measure_setup
        tag: "jwb|jwc"
        _: ""
      - name: postprocess
        tag: "jwb|jwc"
        _: ""
      - name: postprocess
        tag: e4
        mode: text
        separator: |
        _: |
          kill -9 $$(cat ~/powerout.$$label.pid)
          awk '{print "POWERMEASUREMENT: " $0}' ~/powerout.$$label.csv
      - name: job_name
        _: $jube_benchmark_name-$jube_benchmark_padid-$jube_wp_padid-$jube_step_name
      - name: threadspertask
        _: 1
      - name: nodes
        _: 1
      - name: gpus
        tag: e4
        _: 1
      - name: gpus
        tag: "jwc|jwb"
        _: 4
      - name: timelimit
        tag: test
        _: "01:00:00"
      - name: timelimit
        tag: "!test"
        _: "24:00:00"
      - name: account
        tag: jwb|jwc
        _: deepacf
      - name: account
        tag: e4
        _: maelstrom
      - name: gres
        _: gpu:$gpus

      - name: queue
        tag: jwb+!test
        _: booster
      - name: queue
        tag: jwb+test
        _: develbooster
      - name: queue
        tag: "e4+!e4amd"
        _: i-gpu-a100
      - name: queue
        tag: e4amd
        _: a-gpu-mi100
      - name: queue
        tag: jwc+!test
        _: gpus
      - name: queue
        tag: jwc+test
        _: develgpus

      - name: execution_command
        _: apptainer run --nv ${path_apptainer_image}
      - name: executable
        _: ${execution_command} python3 ${jube_benchmark_home}/../../scripts/finetune_deberta/mlflow_projects/deberta_rain_classifier/finetune_deberta_classifier.py
      - name: executable
        tag: split
        _: ${execution_command} python3 ${jube_benchmark_home}/../../scripts/finetune_deberta/mlflow_projects/deberta_rain_classifier/build_dataset_rain_classifier.py
      - name: submit_cmd
        _: sbatch
      - name: visible_devices
        type: string
        separator: ";"
        tag: jwc | jwb
        _: "CUDA_VISIBLE_DEVICES=0"
      - name: visible_devices
        tag: e4
        _: ""
      - name: args_exec
        mode: text
        _: >
          --filename_dataset_train ${filename_dataset_train}
          --filename_dataset_validate ${filename_dataset_validate}
          --filename_dataset_test ${filename_dataset_test}
          --key_input ${key_input}
          --key_output ${key_output}
          --key_raining ${key_raining}
          --key_text ${key_text}

          --model_path ${model_path}
          --model_name ${model_name}
          --num_labels 2
          --trainer_name default

          --random_seed 42
          --epochs ${epochs}
          --batch_size ${batch_size}
          --learning_rate ${learning_rate}
          --weight_decay ${weight_decay}
          --warmup_ratio 0
          --warmup_steps 0
          --hidden_dropout_prob 0.1
          --cls_dropout 0.1
          --lr_scheduler_type linear
          --loss default_loss

          --output_dir ${outdir}
          --folder_run dataset_split_thresh0M2/
      - name: args_exec
        tag: split
        mode: text
        _: >
          --filename_tweets ${filename_tweets}
          --key_precipitation tp_h_mm
          --precipitation_threshold_rain 0.01
          --key_precipitation_station tp_mm_station
          --precipitation_threshold_rain_station 0.1
          --key_distance_weather_station station_distance_km
          --maximum_distance_to_station 1
          --validation_size 0.2
          --test_size 0.2
          --output_dir ${outdir}/
          --folder_run dataset_split_thresh0M2/

patternset:
   - name: perf_patterns
     pattern:
      - {name: jobid, type: int, _: "Running finetuning as args.job_id=$jube_pat_int" }
      - {name: ntweets, type: int, _: "loaded $jube_pat_int tweets"}
      - {name: epoch, type: int, _: "Epoch\\s+$jube_pat_int"}
      - {name: run_time, type: float, _: "RUN\\s+: took ${jube_pat_fp}"}
      - {name: training_time, type: float, _: "TRAINING\\s+: took ${jube_pat_fp}"}
      - {name: epoch_time, type: float, _: "EPOCH\\s+: took ${jube_pat_fp}"}
      - {name: io_time, type: float, _: "IO\\s+: took ${jube_pat_fp}"}
      - {name: forward_time, type: float, _: "FORWARD\\s+: took ${jube_pat_fp}"}
      - {name: backward_time, type: float, _: "BACKWARD\\s+: took ${jube_pat_fp}"}
      - {name: batch_time, type: float, _: "BATCH\\s+: took ${jube_pat_fp}"}
      - {name: evaluation_time, type: float, _: "EVALUATION: took ${jube_pat_fp}"}
      - {name: saving_model_time, type: float, _: "SAVING_MODEL[\\s+]?: took ${jube_pat_fp}"}
      - {name: loss, type: float, _: "{'loss': $jube_pat_fp"}
      - {name: eval_loss, type: float, _: "{'eval_loss': $jube_pat_fp"}
      - {name: max_memory, type: float, _: "Max memory consumption \\[Gbyte\\]: $jube_pat_fp"}
      - {name: nsteps, type: int, _: ", 'step': $jube_pat_int"}
      - {name: ndevices, type: string, _: "CUDA_VISIBLE_DEVICES=${jube_pat_wrd}$"}
      - {name: gpu_max_mem_allocated, type: float, _: "Gpu max memory allocated: ${jube_pat_fp}"}
      - {name: gpu_max_mem_reserved, type: float, _: "Gpu max memory reserved: ${jube_pat_fp}"}
      - {name: label_pat, type: string, _: "POWERMEASUREMENT: Label = $jube_pat_wrd"}
      - {name: time_pat, type: int, _: "POWERMEASUREMENT: $jube_pat_int,$jube_pat_nint,$jube_pat_nint"}
      - {name: watt_pat, type: int, _: "POWERMEASUREMENT: $jube_pat_nint,$jube_pat_int,$jube_pat_nint"}
      - {name: va_pat, type: int, _: "POWERMEASUREMENT: $jube_pat_nint,$jube_pat_nint,$jube_pat_int"}
analyser:
    name: analyse
    reduce: false
    use: perf_patterns
    analyse:
      step: submit
      file:
        - slurm-*.out
        - slurm-out.*
        - slurm-err.*
        - slurm.out
        - slurm.err
        - job.err
        - job.out
        - stdout

result:
    use: analyse
    table:
      name: result
      style: pretty
      sort: iter_pat
      column:
        - {title: "JobID", _: jobid}
        - {title: "#tweets", _: ntweets}
        #- {title: "#steps", _: nsteps_last}
        - {title: "devices", _: ndevices}
        - {title: "queue", _: queue}
        #- {title: "#nodes", _: nodes}
        - {title: "#gpu", _: n_gpu}
        #- {title: "BS", _: batch_size}
        - {title: "T. IO", format: ".4f", _: io_time_sum}
        - {title: "T. run", format: ".4f", _: run_time_last}
        - {title: "T. training", format: ".4f", _: training_time_last}
        - {title: "Avg. epoch", format: ".4f", _: epoch_time_avg}
        - {title: "First epoch", format: ".4f", _: epoch_time_first}
        #- {title: "Min epoch", format: ".4f", _: epoch_time_min}
        #- {title: "Max epoch", format: ".4f", _: epoch_time_max}
        - {title: "Avg. it.", format: ".4f", _: batch_time_avg}
        - {title: "Max it.", format: ".4f", _: batch_time_max}
        - {title: "Ev. time", format: ".4f", _: evaluation_time_max}
        #- {title: "F. loss", format: ".4f", _: loss_last}
        #- {title: "F. eval loss", format: ".4f", _: eval_loss_last}
        #- {title: "M. eval loss", format: ".4f", _: eval_loss_min}
        #- {title: "Saving time", format: ".4f", _: saving_model_time_last}
        #- {title: "l. rate", _: lr}
        #- {title: "min loss", format: ".4f", _: loss_min}
        #- {title: "# epochs", _: epochs}
        #- {title: "Mem", format: ".4f",  _: max_memory}
        - {title: "MaxMemAlloc", format: ".4f", _: gpu_max_mem_allocated_max}
        - {title: "MaxMemReserv", format: ".4f", _: gpu_max_mem_reserved_max}
        #- {title: "Job_Time", _: timelimit}
        #- {title: "Node(s)", _: label_pat}
        #- {title: "Tstart", _: time_pat_first}
        #- {title: "Tend", _: time_pat_last}
        - {title: "Ma.W", format: ".2f", _: watt_pat_max}
        - {title: "A.W", format: ".2f", _: watt_pat_avg}
        #- {title: "Mi.W", format: ".4f", _: watt_pat_min}
        - {title: "Ma.VA", format: ".2f", _: va_pat_max}
        - {title: "A.VA", format: ".2f", _: va_pat_avg}
        #- {title: "Mi.VA", format: ".4f", _: va_pat_min}

step:
  - name: submit
    use:
      - appParameter
      - globalParameter
      - systemParameter
      - executeset
      - from: platform.xml
        _: jobfiles
      - from: platform.xml
        _: executesub
    do:
      done_file: $ready_file
      error_file: $error_file
      _:
        $modules;
        $submit $submit_script;
